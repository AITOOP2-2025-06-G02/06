# モデルクラスのデータ管理の説明

## モデルクラスが管理しているデータ

template_model.pyの10行目のKEY_LISTという変数

self.statusという変数これが最も重要な変数で、レポートのすべてのデータを管理しています。

---

## 1. データが作られるタイミング

プログラムを起動すると、まず__init__メソッドが実行されます。これは12行目から始まっています。

ここで何が起こるかというと、まず「status.json」というファイルがあるかチェックします。

もしファイルがあれば、JSONファイルを読み込んで、その内容をself.status変数に入れます。これが基本的なデータの生成方法です。

もしファイルがなければ、「status.jsonファイルを準備してください」というメッセージを表示して、プログラムを終了します。

---

## 2. データが更新されるタイミング

次に、データがいつ更新されるかを説明します。

### 2.1 ユーザーがGUIで編集したとき

ユーザーが画面上のボタンをクリックして、テキストを編集すると、データが更新されます。

具体的な流れを説明すると、まずユーザーがInputButtonというボタンをクリックします。すると、編集用のダイアログが表示されます。

ユーザーがこのダイアログでテキストを変更するたびに、textChangedというシグナルが発火して、__update_dialog_textというメソッドが呼ばれます。これはmain.pyの97行目にあります。

そして、このメソッドの中で、モデルのset_text_by_keyというメソッドが呼ばれます。これがtemplate_model.pyの188行目から204行目にある処理です。

set_text_by_keyメソッドは、キー名と新しい値を受け取って、self.status辞書の中の対応するデータを更新します。

ここで重要なのは、この時点ではメモリ上のデータが更新されているだけで、まだファイルには保存されていないということです。ユーザーが保存ボタンを押すまで、ファイルは更新されません。

---

## 3. データが保存されるタイミング

最後に、データがファイルに保存されるタイミングを説明します。保存方法は2種類あります。

### 3.1 Saveボタンを押したとき

1つ目は、ユーザーが「Save」ボタンを押したときです。

このとき、save_fileというメソッドが呼ばれます。これは206行目から217行目にあります。

このメソッドは2つの処理を行います。

1つ目は、マークダウンファイルの保存です。ファイル名は、学籍番号と氏名を組み合わせて自動的に作られます。たとえば「K23999愛知太郎.md」といった名前になります。

2つ目は、status.jsonファイルの更新です。self.status辞書の内容を、json.dumpというメソッドを使ってJSONファイルに書き込みます。

ここでindent=4というオプションを使っているので、JSONファイルは見やすく整形されて保存されます。また、ensure_ascii=Falseというオプションによって、日本語がそのまま保存されます。

この2つのファイルを保存することで、次回アプリを起動したときに、前回の編集内容が復元できるようになっています。

### 3.2 Save without historyボタンを押したとき

2つ目の保存方法は、「Save without history」ボタンを押したときです。

このときは、save_file_without_historyというメソッドが呼ばれます。これは219行目から224行目にあります。

この方法では、マークダウンファイルだけが保存されて、status.jsonファイルは更新されません。

つまり、レポートの完成版は出力されるけれど、編集履歴は保存されないということです。

これはどういうときに使うかというと、たとえば一時的にレポートの見た目を確認したいときや、テスト目的で出力したいときに使います。

注意点は、この方法で保存してアプリを終了すると、その編集内容は失われてしまうということです。次回起動したときには、前回のstatus.jsonの内容が読み込まれます。

---
